## Automatic Heap Layout Manipulation for Exploitation

**Sean Heelan, Tom Melham, and Daniel Kroening, University of Oxford**

This paper trys to explain how they develop a novel manner to benchmark heap layout manipulation algorithms. They bring a framework names SHRIKE, which can also perform automatic heap layout manipulation and generate exploits.

Their main contributions are as follows:

    1. An analysis of heap layout manipulation (HLM) problem as a standalone task.

    2. SIEVE, an open source framework for constructing benchmarks for heap layout manipulation and evaluating algorithms.

    3. A pseudo-random black box search algorithm for heap layout manipulation.

    4. SHRIKE, integrates automatic HLM into the exploit development process. 



They classify the challenges in achieving a particular layout depending on whether the allocator behaves deterministically or non-deterministically and whether or not the starting state of the heap is known:

![image](https://github.com/kongjiadongyuan/image_in_a_mess/raw/master/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-02-25%20%E4%B8%8B%E5%8D%889.46.57.png)

Of course, they only consider a known starting state and a deterministic allocator, and assume there are no other actors interacting with the heap. I think this assumption is meaningless, after all, their core idea is violence searching, maybe some heuristic searching, and reuse the results, this just narrows their searching space.



Their main challenges are as follows:

    1. Interaction Noise: maybe the APIs exposed by programs can bring some side effects.

    2. Constraints on allocator interactions: also consider the APIs.

    3. Diversity of Allocator Implementations.

    4. Interaction Sequence Discovery.



![image](https://github.com/kongjiadongyuan/image_in_a_mess/raw/master/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-02-25%20%E4%B8%8B%E5%8D%8810.02.25.png)

Oh, not anymore. -_-



##### Automatic Heap Layout Manipulation

This is the most important part in this paper for me, for some thoughts can be used in our future work. (Maybe the work we are doing, GOOD LUCK 2 ysyy).

This part consists of two problems:

    1. SIEVE: An Evaluation Framwork for HLM Algorithms.

    2. SHRIKE: A HLM System for PHP.



SIEVE develops a set of APIs which are compatible with memory allocators as follow:

![image](https://github.com/kongjiadongyuan/image_in_a_mess/raw/master/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-02-26%20%E4%B8%8A%E5%8D%8811.00.51.png)

The meaning of the framework is that we can use one copy of code to test on different allocators.

In addition, I've done same things before. : D

Here is their benchmark algorithm, `violence search` in a word.......
![image](https://github.com/kongjiadongyuan/image_in_a_mess/raw/master/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-02-26%20%E4%B8%8A%E5%8D%8811.06.43.png)

The thought of the algorithm is to pseudo-randomly generate operation sequences, and judge if the result is what we want, such as two adjacent chunks, etc.

In general, this method is considered stupid, but it works well.



SHRIKE is more specific for PHP framwork. The main difference between them is that SHRIKE considers PHP's built-in functions and data structures. But the essential thoughts are similar.



## conclusion

This paper mainly focus on how to manipulate heap layout, especially the distance between the target chunk.

The method to reach their goal is violence searching, pseudo-randomly generate operation sequences, and search them until we get appropriate layout.

Some good things we may use for reference in the future are as follows:

    1. We can generate a generic testing framework for different allocators, maybe different versions of glibc-malloc.

    2. We don't have to generate exploit in one action. We can manipulate heap layout firstly. (This is what we are doing yet)

    3. The development of exploit operation sequences can be stored in advance, when we need to use it, what we do is only searching.
